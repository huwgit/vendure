"use strict";(self.webpackChunkvendure_admin=self.webpackChunkvendure_admin||[]).push([[599],{8599:(w,f,s)=>{s.r(f),s.d(f,{InvoicesModule:()=>g});var h=s(2583),c=s(6058),d=s(1458),v=s(3066);const b=v.ZP`
  mutation upsertInvoiceConfig($input: InvoiceConfigInput!) {
    upsertInvoiceConfig(input: $input) {
      id
      enabled
      templateString
    }
  }
`,S=v.ZP`
  query invoiceConfig {
    invoiceConfig {
      id
      enabled
      templateString
    }
  }
`,Z=v.ZP`
  query invoices($input: InvoicesListInput) {
    invoices(input: $input) {
      items {
        id
        createdAt
        orderCode
        orderId
        customerEmail
        invoiceNumber
        downloadUrl
      }
      totalItems
    }
  }
`;var C=s(8869),_=s(4172);var e=s(4386),u=s(9348),l=s(2493),y=s(3740);function P(a,n){if(1&a){const t=e.EpF();e.TgZ(0,"clr-accordion-content")(1,"section",4)(2,"form",5)(3,"vdr-form-field",6)(4,"clr-checkbox-wrapper"),e._UZ(5,"input",7),e.qZA()(),e.TgZ(6,"vdr-form-field",8),e._UZ(7,"vdr-dynamic-form-input",9),e.qZA(),e.TgZ(8,"button",2),e.NdJ("click",function(){e.CHM(t);const r=e.oxw();return e.KtG(r.save())}),e._uU(9," Save "),e.qZA(),e.TgZ(10,"button",10),e.NdJ("click",function(){e.CHM(t);const r=e.oxw();return e.KtG(r.testDownload())}),e._uU(11," Preview "),e.qZA(),e._UZ(12,"vdr-help-tooltip",11),e.qZA()()()}if(2&a){const t=e.oxw();e.xp6(2),e.Q6J("formGroup",t.form),e.xp6(5),e.Q6J("readonly",!1)("def",t.htmlFormInputConfigArgsDef)("control",t.form.get("templateString")),e.xp6(1),e.Q6J("disabled",t.form.invalid||t.form.pristine)}}const A=function(a){return["/orders",a]};function T(a,n){if(1&a&&(e.TgZ(0,"td",12),e._uU(1),e.qZA(),e.TgZ(2,"td",12),e._uU(3),e.ALo(4,"date"),e.qZA(),e.TgZ(5,"td",12),e._uU(6),e.qZA(),e.TgZ(7,"td",12)(8,"a",13),e._uU(9),e.qZA()(),e.TgZ(10,"td",12)(11,"a",14),e._UZ(12,"clr-icon",15),e.qZA()()),2&a){const t=n.item;e.xp6(1),e.Oqu(t.invoiceNumber),e.xp6(2),e.hij(" ",e.lcZ(4,6,t.createdAt)," "),e.xp6(3),e.Oqu(t.customerEmail),e.xp6(2),e.Q6J("routerLink",e.VKq(8,A,t.orderId)),e.xp6(1),e.hij(" ",t.orderCode," "),e.xp6(2),e.Q6J("href",t.downloadUrl,e.LSH)}}class m{constructor(n,t,o,r,i){this.formBuilder=n,this.dataService=t,this.changeDetector=o,this.notificationService=r,this.localStorageService=i,this.itemsPerPage=10,this.page=1,this.selectedInvoices=[],this.htmlFormInputConfigArgsDef={name:"templateString",type:"text",list:!1,required:!1,ui:{component:"html-editor-form-input"}},this.isSelected=p=>!!this.selectedInvoices?.find(U=>U.id===p.id),this.form=this.formBuilder.group({enabled:["enabled"],templateString:["templateString"]}),this.serverPath=(0,c.VC)()}ngOnInit(){var n=this;return(0,d.Z)(function*(){n.dataService.query(S).mapStream(t=>t.invoiceConfig).subscribe(t=>{n.form.controls.enabled.setValue(t?.enabled),n.form.controls.templateString.setValue(t?.templateString)}),yield n.getAllInvoices()})()}getAllInvoices(){var n=this;return(0,d.Z)(function*(){yield n.dataService.query(Z,{input:{page:n.page,itemsPerPage:n.itemsPerPage}}).mapStream(t=>t.invoices).subscribe(t=>{n.invoicesList=t})})()}save(){var n=this;return(0,d.Z)(function*(){try{if(n.form.dirty){const t=n.form.value,o=yield n.dataService.mutate(b,{input:{enabled:t.enabled,templateString:t.templateString}}),{upsertInvoiceConfig:r}=yield function I(a,n){const t="object"==typeof n;return new Promise((o,r)=>{const i=new _.Hp({next:p=>{o(p),i.unsubscribe()},error:r,complete:()=>{t?o(n.defaultValue):r(new C.K)}});a.subscribe(i)})}(o);n.form.controls.enabled.setValue(r.enabled),n.form.controls.templateString.setValue(r.templateString)}n.form.markAsPristine(),n.changeDetector.markForCheck(),n.notificationService.success("common.notify-update-success",{entity:"InvoiceConfig"})}catch{n.notificationService.error("common.notify-update-error",{entity:"InvoiceConfig"})}})()}downloadSelected(){var n=this;return(0,d.Z)(function*(){try{const t=n.selectedInvoices.map(i=>i.invoiceNumber).join(","),o=yield fetch(`${n.serverPath}/invoices/download?nrs=${t}`,{headers:n.getHeaders()});if(!o.ok){const i=yield o.json();throw Error(i?.message)}const r=yield o.blob();yield n.downloadBlob(r,"invoices.zip")}catch(t){console.error(t),n.notificationService.error(t?.message)}})()}setPageNumber(n){var t=this;return(0,d.Z)(function*(){t.page=n,yield t.getAllInvoices()})()}setItemsPerPage(n){var t=this;return(0,d.Z)(function*(){t.page=1,t.itemsPerPage=Number(n),yield t.getAllInvoices()})()}toggleSelect(n){this.isSelected(n)?this.selectedInvoices=this.selectedInvoices.filter(t=>t.id!==n.id):this.selectedInvoices.push(n)}toggleSelectAll(){this.areAllSelected()?this.selectedInvoices=[]:this.selectedInvoices=this.invoicesList?.items||[]}areAllSelected(){return this.selectedInvoices.length===this.invoicesList?.items.length}testDownload(){var n=this;return(0,d.Z)(function*(){try{const t=n.form.value.templateString,o=yield fetch(`${n.serverPath}/invoices/preview`,{headers:{...n.getHeaders(),"Content-Type":"application/json"},method:"POST",body:JSON.stringify({template:t})});if(!o.ok){const i=yield o.json();throw Error(i?.message)}const r=yield o.blob();yield n.downloadBlob(r,"test-invoice.pdf",!0)}catch(t){console.error(t),n.notificationService.error(t?.message)}})()}getHeaders(){const n={},t=this.localStorageService.get("activeChannelToken");t&&(n["vendure-token"]=t);const o=this.localStorageService.get("authToken");return o&&(n.authorization=`Bearer ${o}`),n}downloadBlob(n,t,o=!1){return(0,d.Z)(function*(){const r=window.URL.createObjectURL(n),i=document.createElement("a");document.body.appendChild(i),i.setAttribute("hidden","true"),i.href=r,o||(i.download=t),i.setAttribute("target","_blank"),i.click()})()}static#e=this.\u0275fac=function(t){return new(t||m)(e.Y36(u.qu),e.Y36(c.DoR),e.Y36(e.sBO),e.Y36(c.gqp),e.Y36(c.n2A))};static#t=this.\u0275cmp=e.Xpm({type:m,selectors:[["invoices-component"]],decls:26,vars:7,consts:[[1,"page-block"],[4,"clrIfExpanded"],[1,"btn","btn-primary",3,"disabled","click"],[3,"items","itemsPerPage","totalItems","currentPage","allSelected","isRowSelectedFn","pageChange","itemsPerPageChange","rowSelectChange","allSelectChange"],[1,"form-block"],[1,"form",3,"formGroup"],["label","Generate invoices on","for","enabled"],["type","checkbox","clrCheckbox","","formControlName","enabled"],["label","HTML template","for","templateString"],["formControlName","templateString",2,"max-width","100%",3,"readonly","def","control"],[1,"btn","btn-secondary",3,"click"],["content","Preview the HTML template. Uses the most recent placed order. Just a preview, it doesn't save any invoices!"],[1,"left","align-middle"],[3,"routerLink"],["target","_blank",3,"href"],["shape","download"]],template:function(t,o){1&t&&(e.TgZ(0,"div",0)(1,"clr-accordion")(2,"clr-accordion-panel")(3,"clr-accordion-title"),e._uU(4,"Settings"),e.qZA(),e.YNc(5,P,13,5,"clr-accordion-content",1),e.qZA()(),e._UZ(6,"hr"),e.TgZ(7,"section")(8,"h2"),e._uU(9,"Created invoices"),e.qZA(),e.TgZ(10,"button",2),e.NdJ("click",function(){return o.downloadSelected()}),e._uU(11," Download "),e.qZA(),e._UZ(12,"br")(13,"br"),e.TgZ(14,"vdr-data-table",3),e.NdJ("pageChange",function(i){return o.setPageNumber(i)})("itemsPerPageChange",function(i){return o.setItemsPerPage(i)})("rowSelectChange",function(i){return o.toggleSelect(i)})("allSelectChange",function(){return o.toggleSelectAll()}),e.TgZ(15,"vdr-dt-column"),e._uU(16,"Invoice nr."),e.qZA(),e.TgZ(17,"vdr-dt-column"),e._uU(18,"Created"),e.qZA(),e.TgZ(19,"vdr-dt-column"),e._uU(20,"Customer"),e.qZA(),e.TgZ(21,"vdr-dt-column"),e._uU(22,"Order"),e.qZA(),e.TgZ(23,"vdr-dt-column"),e._uU(24,"Download"),e.qZA(),e.YNc(25,T,13,10,"ng-template"),e.qZA()()()),2&t&&(e.xp6(10),e.Q6J("disabled",0==(null==o.selectedInvoices?null:o.selectedInvoices.length)),e.xp6(4),e.Q6J("items",null==o.invoicesList?null:o.invoicesList.items)("itemsPerPage",o.itemsPerPage)("totalItems",null==o.invoicesList?null:o.invoicesList.totalItems)("currentPage",o.page)("allSelected",o.areAllSelected())("isRowSelectedFn",o.isSelected))},dependencies:[l.Nz$,l.qvL,l.DbV,l.KKC,l.PEh,l.bZL,l.GmI,l.UJ5,l.r6y,l.dxz,l.twP,u._Y,u.Wl,u.JJ,u.JL,u.sg,u.u,h.rH,c.Qj_,c.Egy,c.hgI,c.y_K,c.opf,c.TVJ,y.uU],encapsulation:2})}class g{static#e=this.\u0275fac=function(t){return new(t||g)};static#t=this.\u0275mod=e.oAB({type:g});static#n=this.\u0275inj=e.cJS({imports:[c.m81,h.Bz.forChild([{path:"",pathMatch:"full",component:m,data:{breadcrumb:"Invoices"}}])]})}}}]);
//# sourceMappingURL=599.51986c1f536da04b.js.map